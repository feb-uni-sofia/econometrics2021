---
title: "Week4"
author: "Boyko Amarov"
date: "3/30/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
invoices <- read.delim('https://raw.githubusercontent.com/feb-uni-sofia/econometrics2020-solutions/master/data/invoices.txt')
```


```{r}
glimpse(invoices)
```

Variables description:

- `Day` (numeric): day
- `Invoices` (numeric): number of invoices
- `Time` (numeric): Time needed to process the invoices (hours)

Task is to predict the time needed to process 50, 120, 200, 250 invoices.

```{r}
summary(invoices$Time)
```


```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_vline(xintercept = c(80, 250), lty = 2, alpha = 0.3) +
  geom_vline(xintercept = 120, lty = 2) +
  geom_hline(yintercept = 2.110) +
  geom_abline(intercept = 0.1, slope = 0.015, colour = "steelblue2")
```

Estimate the expected processing time for 80, 120 and 250 invoices (3 estimates).

Strategy 1: Use the average processing time for the predictions

$$
i = 1,\ldots,n = 30\\
x_i: \text{ number of invoices on day } i \\
y_i: \text{ processing time on day } i \\
$$
Assume a simple (linear) functional relationship

$$
y = 0.1 + 0.015x
$$



$$
y[\text{hours}] = 0.1[\text{hours}] + \underbrace{0.015\left[\frac{\text{hours}}{\text{invoice}}\right] x[\text{numb. invoices}]}_{\text{hours}}\\
x = 0 \implies y [\text{hours}] = 0.1 [\text{hours}]
$$


$$
50 [m^2] \text{ room}\\
\text{rent } 2[\frac{BGN}{m^2}]\\
2 [\frac{BGN}{m^2}] \times 50 [m^2] = 100 [BGN]
$$

$$
y[\text{costs}] = 0.1[\text{fixed costs}] + 0.015[\text{marginal cost}]x[\text{production}]
$$

$$
y_{x = 120} = 0.1 + 0.015 \times 120 = 1.9 [\text{hours}]
$$

$$
y = \underbrace{0.1}_{\text{intercept}} + \underbrace{0.015}_{\text{slope}}x
$$

$$
y_i  = \underbrace{0.1 + 0.015x_i}_{\text{line, systematic part}} + \underbrace{e_i}_{\text{deviation from the line, stochastic (random) part}}
$$


```{r}
x <- 190
line_part <- 0.1 + 0.015 * x

deviation_part <- runif(1, min = -1, max = 1)

deviation_part

y <- line_part + deviation_part
y
```

```{r}
rand_numbers <- runif(10000, min = -1, max = 1)
# rand_numbers
mean(rand_numbers)
```

Assume that the deviation part is zero on average.

$$
E(e_i) = 0 \text{ assumption} \implies \\
E(y_i) = E(0.1 + 0.015x_i + e_i) =\\ 
E(y_i) = E(0.1) + E(0.015x_i) + E(e_i) = \\
E(y_i) = 0.1 + 0.015x_i
$$

## Coefficient estimation

$$
y = 0.1 + 0.015x + e_i
$$
Predicted y (expected value of y) for every observation

$$
\hat{y}_i = 0.1 + 0.015x_i
$$
```{r}
invoices <- invoices %>%
  mutate(
    y_predicted_1 = 0.1 + 0.015 * Invoices
  )

## Code for illustration purposes

ggplot(data = invoices, aes(x = Invoices, y = Time)) +
  geom_point(size = 2) +
  geom_segment(
    aes(xend = Invoices, yend = y_predicted_1),
    size = 1 / 4
  ) +
  geom_line(aes(y = y_predicted_1), color = "steelblue2")
```


Difference between observed and expected (predicted) processing time.

$$
r_i  =y_i - \hat{y}_{i} \text{ residual for day } i
$$

Distance between expected and observed values (processing time).

$$
y_i = \alpha + \beta x_i + e_i\\
\hat{y}_{i} = \hat{\alpha} + \hat{\beta} x \quad \hat{\alpha} \text{ guess for } \alpha \quad \hat{\beta} \text{ guess for } \beta\\
\underbrace{\min}_{\hat{\alpha}, \hat{\beta}} \sum_{i = 1}^{n} (y_i - \hat{y}_{i})^2\\

E(y) = \alpha  +\beta x\\
\hat{E}(y) = \hat{\alpha}  + \hat{\beta} x\\
$$
Result of minimisation is what we call the (ordinary) least squares estimator.


```{r}
## lm: linear model
fit <- lm(Time ~ 1 + Invoices, data = invoices)
## OLS estimates for alpha (Intercep) and beta (the coefficient for Invoices)
fit
```
Estimated equation


$$
\hat{E}(y) = \hat{y}^{OLS} = 0.64 + 0.011 x
$$


```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_hline(yintercept = 2.110) +
  geom_abline(intercept = 0.1, slope = 0.015, colour = "steelblue2") + 
  geom_abline(intercept = 0.64, slope = 0.011, colour = "firebrick")
```

```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_smooth(method = "lm")
```


## Plot the OLS estimated line

```{r}
## Calculate the predicted y using the OLS estimates (guesses) for alpha and beta
invoices <- invoices %>%
  mutate(
    y_OLS = 0.64 + 0.011 * Invoices
  )
```




<!-- ```{r} -->
<!-- ggplot(data = invoices, aes(x = Invoices, y = Time)) + -->
<!--   geom_point(size = 2, shape = 1) + -->
<!--   geom_segment( -->
<!--     aes(xend = Invoices, yend = Est_mean), -->
<!--     size = 1 / 4 -->
<!--   ) + -->
<!--   geom_line(aes(y = Est_mean)) -->
<!-- ``` -->

$$
y_i = \underbrace{\alpha + \beta x_i}_{\text{line, systematic part}} + \underbrace{e_i}_{\text{deviation, stochastic (random) part}}, \quad i = 1,\ldots,n
$$


$$
x = 120 \\
y_i = \underbrace{\alpha + \beta 120}_{\text{line, systematic part}} + \underbrace{e_i}_{\text{result of a dice}}, \quad i = 1,\ldots,n
$$
```{r}
mean(runif(1000, min = -1, max = 1))
```

Assume that $e_i$ are zero on average.

$$
E(e_i) = 0\\
$$
$$
E(y_i) = E(\alpha + \beta x_i + e_i) = \\
\underbrace{E(\alpha + \beta x_i)}_{\alpha + \beta x_i} + \underbrace{E(e_i)}_{0} \implies\\
E(y_i) = \alpha + \beta x_i
$$








$$
y_i [\text{hours}] = 0.1[\text{hours}] + \underbrace{
0.015\left[\frac{\text{hours}}{\text{invoice}}\right] x_i [\text{number of invoices}]}_{\text{hours}},
\quad i = 1,\ldots,n
$$
Predictions using this equation:

$$
\hat{y}_{x = 120} = 0.1 + 0.015 \times 120 = 1.9 \text{ hours}
$$

$$
\underbrace{y}_{\text{costs in terms of time}} = \\ 
\underbrace{0.1}_{\text{fixed costs}} + \\
\underbrace{0.015}_{\text{marginal costs}}\\ \underbrace{x}_{\text{number of invoices (work)}}
$$

$$
y_i = \underbrace{\alpha + \beta x_i}_{\text{line: systematic part}} + \underbrace{e_i}_{\text{deviation from the line: stochastic (random) part}}
$$

Assume that the $e_i$ are random (like dice throw). Assume that the deviations are zero on average.

$$
E(e_i) = 0 \text{ expected value of } e_i \text{ equals zero}
$$
$$
E(y_i) = E(\alpha + \beta x_i + e_i) = \\
\alpha + \beta x_i + E(e_i) = \\
E(y_i) = \underbrace{\alpha + \beta x_i}_{line} \text{ the expected processing time}
$$
Next time: ordinary least squares estimator



```{r}
tmp <- lm(Time ~ Invoices, data = invoices)
summary(tmp)
r <- residuals(tmp)
sqrt(var(r) * (29 / (30 - 2)))
```


<!-- Strategy 1: use the observed value for 120 invoices (2.5 h) as a prediction -->
<!-- Strategy 2: use the (daily) average processing time (this will overestimate low work loads (low number of invoices) and will underestimate high work loads, because there is an increasing  -->
<!-- pattern in the data: high work loads are associated with longer work time). -->

<!-- Strategy 3: use the average time to process one invoice? -->



<!-- $$ -->
<!-- y_i = \alpha + \beta x_i, \quad i = 1,\ldots,n\\ -->
<!-- \alpha = 0, \beta = 0.015\\ -->
<!-- y_i = 0 + 0.015 x_i \text{ (blue line)} -->
<!-- $$ -->
<!-- $$ -->
<!-- \text{Estimated time to process 120 invoices}\\ -->
<!-- \hat{y}_{x = 120} = 0 + 0.015 \times 120 = 1.8 \text{ hours} -->
<!-- $$ -->

<!-- $$ -->
<!-- y_i = \underbrace{\alpha + \beta x_i}_{\text{line/systematic part}} + \underbrace{e_i}_{\text{deviation from the line, stochastic (random) part}} -->
<!-- $$ -->
<!-- Assumptions about $e_i$, we assume that the deviations are zero on average. -->

<!-- $$ -->
<!-- E(e_i) = 0 \text{ zero on average} -->
<!-- $$ -->
<!-- $$ -->
<!-- \hat{y} = \alpha + \beta x -->
<!-- $$ -->

<!-- ## OLS estimator -->

<!-- Usd the *O*rdinary *L*east *S*quares estimator to find "guesses" for alpha and beta. -->

<!-- ```{r} -->
<!-- ## lm: linear model -->
<!-- fit <- lm(Time ~ 1 + Invoices, data = invoices) -->
<!-- fit -->
<!-- ``` -->

<!-- $$ -->
<!-- \hat{\alpha} = 0.64 {\text{ OLS guess for } \alpha }\\ -->
<!-- \hat{\beta} = 0.011 {\text{ OLS guess for } \beta} \\ -->
<!-- \hat{y} = \hat{\alpha} + \hat{\beta}x\\ -->
<!-- \hat{y} = 0.64 + 0.011x \text{ OLS guess for the equation}\\ -->
<!-- \hat{y}_{x = 120} = 0.64 + 0.011 \times 120 = 1.96 \text{ hours} -->
<!-- $$ -->
<!-- $$ -->

<!-- y_i [\text{hours}] = \alpha [\text{hours}] + \beta\left[\frac{\text{hours}}{\text{invoice}}\right] x_i [\text{Number of invoices}] + e_i [\text{hours}] -->
<!-- $$ -->

## Residuals

```{r}
invoices$Est_mean <- predict(lm(Time ~ Invoices, data = invoices))
invoices %>%
  ggplot(aes(x = Invoices, y = Time)) +
  geom_point(size = 2, shape = 1) +
  geom_segment(
    aes(xend = Invoices, yend = Est_mean),
    size = 1 / 4
  ) +
  geom_line(aes(y = Est_mean))
```
