---
title: "Week4"
author: "Boyko Amarov"
date: "3/30/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
invoices <- read.delim('https://raw.githubusercontent.com/feb-uni-sofia/econometrics2020-solutions/master/data/invoices.txt')
```


```{r}
glimpse(invoices)
```

Variables description:

- `Day` (numeric): day
- `Invoices` (numeric): number of invoices
- `Time` (numeric): Time needed to process the invoices (hours)

Task is to predict the time needed to process 50, 120, 200, 250 invoices.

```{r}
summary(invoices$Time)
```


```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_vline(xintercept = c(80, 250), lty = 2, alpha = 0.3) +
  geom_vline(xintercept = 120, lty = 2) +
  geom_hline(yintercept = 2.110) +
  geom_abline(intercept = 0.1, slope = 0.015, colour = "steelblue2")
```

Estimate the expected processing time for 80, 120 and 250 invoices (3 estimates).

Strategy 1: Use the average processing time for the predictions

$$
i = 1,\ldots,n = 30\\
x_i: \text{ number of invoices on day } i \\
y_i: \text{ processing time on day } i \\
$$
Assume a simple (linear) functional relationship

$$
y = 0.1 + 0.015x
$$



$$
y[\text{hours}] = 0.1[\text{hours}] + \underbrace{0.015\left[\frac{\text{hours}}{\text{invoice}}\right] x[\text{numb. invoices}]}_{\text{hours}}\\
x = 0 \implies y [\text{hours}] = 0.1 [\text{hours}]
$$


$$
50 [m^2] \text{ room}\\
\text{rent } 2[\frac{BGN}{m^2}]\\
2 [\frac{BGN}{m^2}] \times 50 [m^2] = 100 [BGN]
$$

$$
y[\text{costs}] = 0.1[\text{fixed costs}] + 0.015[\text{marginal cost}]x[\text{production}]
$$

$$
y_{x = 120} = 0.1 + 0.015 \times 120 = 1.9 [\text{hours}]
$$

$$
y = \underbrace{0.1}_{\text{intercept}} + \underbrace{0.015}_{\text{slope}}x
$$

$$
y_i  = \underbrace{0.1 + 0.015x_i}_{\text{line, systematic part}} + \underbrace{e_i}_{\text{deviation from the line, stochastic (random) part}}
$$


```{r}
x <- 190 ## Number of invoices
e <- runif(1, min = -1, max = 1) ## Uniform distribution on [-1, 1]
e
y <- 0.1 + 0.015 * x + e
y
```

```{r}
rand_numbers <- runif(10, min = -1, max = 1)
# rand_numbers
paste("Average result from a game:", mean(rand_numbers))
rand_numbers
```

Assume that the deviation part is zero on average.

$$
E(e_i) = 0 \text{ assumption} \implies \\
E(y_i) = E(0.1 + 0.015x_i + e_i) =\\ 
E(y_i) = E(0.1) + E(0.015x_i) + E(e_i) = \\
E(y_i) = 0.1 + 0.015x_i
$$

## Coefficient estimation

$$
y = 0.1 + 0.015x + e_i
$$
Predicted y (expected value of y) for every observation

$$
\hat{y}_i = 0.1 + 0.015x_i
$$

```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_abline(intercept = 0.6, slope = 0.015, colour = "steelblue2") +
  geom_abline(intercept = 0.3, slope = 0.02, colour = "steelblue2", alpha = 0.5) +
  geom_abline(intercept = 0.6, slope = 0.010, colour = "steelblue2", alpha = 0.5) +
  geom_abline(intercept = 2, slope = 0.015, colour = "firebrick")
```


$$
y_i - \hat{y_i} \text{ residual for day } i
$$
$$
y_i = \alpha + \beta x_i + e_i\\
E(y_i) = \alpha + \beta x_i
$$
Find guesses for $\alpha$ and $\beta$ based on the data, so that the distance between
the predictions and the observations is as small as possible. Let's call our
"guesses" for $\alpha$ $\hat{\alpha}$ and for $\beta$ $\hat{\beta}$

$$
\hat{y}_i = \hat{E}(y_i) = \hat{\alpha} + \hat{\beta}x_i \text{ guessed expected value}\\
(\hat{\alpha}^{OLS}, \hat{\beta}^{OLS}) = \min_{\hat{\alpha}, \hat{\beta}} \sum_{i = 1}^{n}(y_i - \hat{y}_i)^2
$$

The result of this minimisation is what we call the OLS (ordinary least squares) estimator for $\alpha$ and for $\beta$.

## Application in R

```{r}
## lm: linear model
lm(Time ~ 1 + Invoices, data = invoices)
```

Estimated equation using OLS.
$$
\hat{y}_i =  0.64 + 0.012 x_i
$$
We estimate the expected processing time at $x_i$ invoice to be the sum the estimated fixed costs (0.64 hours) plus the estimated marginal costs (0.012 hours/invoice) times the number of invoices ($x_i$).

$$
\hat{y} =  0.64 + 0.012 x
$$

The expected processing time increases by 0.012 *hours* for each additional invoice.

The expected processing time at zero invoices is 0.64 _hours_.

## Plot the OLS estimated line

```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_abline(intercept = 0.1, slope = 0.015, colour = "steelblue2") +
  geom_abline(intercept = 0.64, slope = 0.012, colour = "firebrick")
```
```{r}
ggplot(data = invoices, aes(x = Invoices, y = Time)) + 
  geom_point() +
  geom_smooth(method = "lm")
```

$$
y_i = \underbrace{\alpha + \beta x_i}_{\text{line, systematic part}} + \underbrace{e_i}_{\text{deviation, stochastic (random) part}}, \quad i = 1,\ldots,n
$$


$$
x = 120 \\
y_i = \underbrace{\alpha + \beta 120}_{\text{line, systematic part}} + \underbrace{e_i}_{\text{result of a dice}}, \quad i = 1,\ldots,n
$$
```{r}
mean(runif(1000, min = -1, max = 1))
```

Assume that $e_i$ are zero on average.

$$
E(e_i) = 0\\
$$
$$
E(y_i) = E(\alpha + \beta x_i + e_i) = \\
\underbrace{E(\alpha + \beta x_i)}_{\alpha + \beta x_i} + \underbrace{E(e_i)}_{0} \implies\\
E(y_i) = \alpha + \beta x_i
$$








$$
y_i [\text{hours}] = 0.1[\text{hours}] + \underbrace{
0.015\left[\frac{\text{hours}}{\text{invoice}}\right] x_i [\text{number of invoices}]}_{\text{hours}},
\quad i = 1,\ldots,n
$$
Predictions using this equation:

$$
\hat{y}_{x = 120} = 0.1 + 0.015 \times 120 = 1.9 \text{ hours}
$$

$$
\underbrace{y}_{\text{costs in terms of time}} = \\ 
\underbrace{0.1}_{\text{fixed costs}} + \\
\underbrace{0.015}_{\text{marginal costs}}\\ \underbrace{x}_{\text{number of invoices (work)}}
$$

$$
y_i = \underbrace{\alpha + \beta x_i}_{\text{line: systematic part}} + \underbrace{e_i}_{\text{deviation from the line: stochastic (random) part}}
$$

Assume that the $e_i$ are random (like dice throw). Assume that the deviations are zero on average.

$$
E(e_i) = 0 \text{ expected value of } e_i \text{ equals zero}
$$
$$
E(y_i) = E(\alpha + \beta x_i + e_i) = \\
\alpha + \beta x_i + E(e_i) = \\
E(y_i) = \underbrace{\alpha + \beta x_i}_{line} \text{ the expected processing time}
$$
Next time: ordinary least squares estimator



```{r}
tmp <- lm(Time ~ Invoices, data = invoices)
summary(tmp)
r <- residuals(tmp)
sqrt(var(r) * (29 / (30 - 2)))
```


<!-- Strategy 1: use the observed value for 120 invoices (2.5 h) as a prediction -->
<!-- Strategy 2: use the (daily) average processing time (this will overestimate low work loads (low number of invoices) and will underestimate high work loads, because there is an increasing  -->
<!-- pattern in the data: high work loads are associated with longer work time). -->

<!-- Strategy 3: use the average time to process one invoice? -->



<!-- $$ -->
<!-- y_i = \alpha + \beta x_i, \quad i = 1,\ldots,n\\ -->
<!-- \alpha = 0, \beta = 0.015\\ -->
<!-- y_i = 0 + 0.015 x_i \text{ (blue line)} -->
<!-- $$ -->
<!-- $$ -->
<!-- \text{Estimated time to process 120 invoices}\\ -->
<!-- \hat{y}_{x = 120} = 0 + 0.015 \times 120 = 1.8 \text{ hours} -->
<!-- $$ -->

<!-- $$ -->
<!-- y_i = \underbrace{\alpha + \beta x_i}_{\text{line/systematic part}} + \underbrace{e_i}_{\text{deviation from the line, stochastic (random) part}} -->
<!-- $$ -->
<!-- Assumptions about $e_i$, we assume that the deviations are zero on average. -->

<!-- $$ -->
<!-- E(e_i) = 0 \text{ zero on average} -->
<!-- $$ -->
<!-- $$ -->
<!-- \hat{y} = \alpha + \beta x -->
<!-- $$ -->

<!-- ## OLS estimator -->

<!-- Usd the *O*rdinary *L*east *S*quares estimator to find "guesses" for alpha and beta. -->

<!-- ```{r} -->
<!-- ## lm: linear model -->
<!-- fit <- lm(Time ~ 1 + Invoices, data = invoices) -->
<!-- fit -->
<!-- ``` -->

<!-- $$ -->
<!-- \hat{\alpha} = 0.64 {\text{ OLS guess for } \alpha }\\ -->
<!-- \hat{\beta} = 0.011 {\text{ OLS guess for } \beta} \\ -->
<!-- \hat{y} = \hat{\alpha} + \hat{\beta}x\\ -->
<!-- \hat{y} = 0.64 + 0.011x \text{ OLS guess for the equation}\\ -->
<!-- \hat{y}_{x = 120} = 0.64 + 0.011 \times 120 = 1.96 \text{ hours} -->
<!-- $$ -->
<!-- $$ -->

<!-- y_i [\text{hours}] = \alpha [\text{hours}] + \beta\left[\frac{\text{hours}}{\text{invoice}}\right] x_i [\text{Number of invoices}] + e_i [\text{hours}] -->
<!-- $$ -->

## Residuals

```{r}
invoices$Est_mean <- predict(lm(Time ~ Invoices, data = invoices))
invoices %>%
  ggplot(aes(x = Invoices, y = Time)) +
  geom_point(size = 2, shape = 1) +
  geom_segment(
    aes(xend = Invoices, yend = Est_mean),
    size = 1 / 4
  ) +
  geom_line(aes(y = Est_mean))
```
